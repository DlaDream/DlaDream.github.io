---
layout:     post
title:      Linux-存储管理
date:       2020-1-12
author:     DlaDream
header-img: img/post-bg-kuaidi.jpg
tags:
     - Linux

---

## Linux-存储管理

   存储管理的任务是方便用户使用存储资源，在有限的物理空间内使更多的用户进程高效的获得和使用尽可能多的存储空间，从而提高系统的整体性能。

   Linux使用段页式存储管理。

   Linux中存在虚拟内存，将4GB的虚拟内存分为两种，1~3GB是用户态空间；3GB~4GB是核心态使用，由所有进程共享，但是只有核心态的进程才可以访问。

> 段按照程序的逻辑结构将程序分为很多的段

### Linux存储管理

   Linux存储管理使用段页式存储方式，采用最小限度的段机制和三级分页机制。

> 最小限度是指将所有的存储空间分到一个段之中，即Linux之中只有一个段

   Linux存储管理使用两级保护机制

- 0级：为核心态

- 3级：用户态

#### 地址映射

   每当进程启动的时候系统会分配一个task_struct结构，其中mm_struct是与用户进程中与存储有关的信息。

   Linux中定义了虚存段VMA，一个VMA是一个连续的线性地址区间。VMA中有指向mm_struct的指针，而且有虚存段的起始位置和终止位置。

> vma会动态改变，存在归并和拆分。分配vma的时候并不会立即分配页帧

![](https://i.loli.net/2019/12/18/OPZv6Q43YUpsB87.png)

  进程虚拟存储空间管理：

1. 由进程的task_struct找到mm_struct的指针

2. 根据mm_struct指针找到mm_struct结构

#### 共享和保护

  共享：通过将不同的vma映射到相同的物理块实现

  保护：通过特权级和分段的访问权限实现

   Linux可以对虚存进行加锁，加锁之后之后的页面会一直保存在内存中，不会被换出

#### 内存分类

  Linux内的物理内存可以分为节点、管理区和页帧

- 节点：处理器的本地内存组成的区域称为一个节点

- 区：每个节点的物理内存因为功能的不同可以分为不同的区

- 页帧：物理内存是以页帧为基本单位，页帧的大小固定

  Linux使用伙伴系统有效的分配和释放物理页面，分配和回收是以2的k次幂个页面为单位进行的

**内核态的内存空间**

   内核态的空间的分配和释放是以块为单位的。因为伙伴系统的分配是以页帧为单位的，容易造成小空间的浪费，所以内核态使用slab分配器。

   slab分配器：为经常使用的小对象建立缓冲，小对象的申请与释放通过slab分配器管理，slab管理器与伙伴系统打交道。

**交换空间**

   当进程需要将虚拟页放到物理页中时，如果没有空闲的物理页则需要进行换出操作：

- 如果需要换出的页面是磁盘上的文件，而且没有被修改过，则直接换出

- 如果需要换出的页面被修改过，则被换出时同时存入到交换文件中，因为访问交换文件的速度和访问处理器以及物理内存的速度相差很多，所以操作系统要决定是否将数据写回，还是留在内存中方面下次访问。

> linux使用LRU策略，即最近最少访问原则
> 
> 内存态的空间不允许换出

   实现释放页面的进程由核心交换定时器周期性的调用。

- 当空闲页面的数量高于free_pages_high时不做任何操作，继续睡眠等待下一次调用

- 当空闲页面低于free_pages_low时通过三个途径减少系统使用的空闲页面数量

   睡眠时间不是固定的，如果页面数量小于free_pages_low则释放页面后睡眠一半的时间；如果是页面数量大于free_pages_high则睡眠时间延长

**三个减少系统使用物理页面的方法**

- 减少PageCathe和buffer的大小

- 将系统V类型的内存页面换出去

- 换出或丢弃进程占用的页面

> 当页面数量少于free_pages_low时释放6个页面，否则只释放3个页面
> 
> 会自动记录上次释放成功的方法，优先使用上次释放成功的方法

   优先考虑释放PageCathe和buffer中的页面，因为释放这些页面并不会造成非常大的影响

   系统V类型内存页面是一种用来在进程之间共享虚拟内存来实现进程通信的机制。

> age数值越小标识进程越老，越容易被换出去
